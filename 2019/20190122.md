# 22 January 2019

Examples of compiling to JavaScript:

- [elm/compiler](https://github.com/elm/compiler/blob/a6568a63f3ffc4defdb608d180b23a0113a89342/compiler/src/Generate/JavaScript/Builder.hs)
- [purescript/purescript](https://github.com/purescript/purescript/blob/master/src/Language/PureScript/CodeGen/JS.hs)

## Re-using state/environment in a REPL loop

I want to preserve the REPL environment after each loop.
I'm using the ReaderT monad to model the environment.
How does this work?
I start with a default environment.
Whenever there is a call to `define`, I use `local` to update the environment.
`local` runs an action in a modified environment.
The modified environment is separate from the original environment.
Whatever follows the action does not have access to the modified environment.
This is how I do lexical scope.

```scheme
(begin 
  (define foo 1)
  (define bar 2)
  (define baz 
    (lambda (x) 
      ((define y 3) (+ x y)))))
```

What's confusing to me is how I can update the same scope more than once.
Calling `local` makes sense when the environment is modified for everything under
that branch of the AST.
But in the above example, I modify on the first branch (`define foo...`), and 
the modified environment is also available on the two other sibling branches.
Why?

- [Elm REPL](https://github.com/elm/compiler/blob/master/terminal/src/Repl.hs)
